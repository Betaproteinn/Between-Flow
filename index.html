<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Between Flow v1.955</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* --- Ê†∏ÂøÉ‰øÆÂ§çÔºöFlex + Sticky Â∏ÉÂ±Ä --- */
        
        /* 1. ÂÆö‰πâ‰∏ªÈ¢òÂèòÈáè (Êñ∞Â¢û) */
        :root {
            --bg-sidebar: #2B2D31;
            --bg-main: #313338;
            --bg-input: #383A40;
            --text-main: #DBDEE1;
            --text-header: #F2F3F5;
            --accent-color: #5865F2;
            --border-color: rgba(255, 255, 255, 0.08);
            --timestamp: #949BA4;
            --scrollbar-thumb: rgba(0, 0, 0, 0.5);
        }

        html, body, #root { 
            height: 100dvh; 
            width: 100%; 
            margin: 0; 
            background-color: var(--bg-main); /* ‰ΩøÁî®ÂèòÈáè */
            color: var(--text-main);          /* ‰ΩøÁî®ÂèòÈáè */
            font-family: "Whitney", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* ÊªöÂä®Êù°ÁæéÂåñ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; background-color: var(--bg-sidebar); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: var(--bg-sidebar); }
        
        .gutter-cell { font-family: 'Consolas', 'Monaco', 'Courier New', monospace; user-select: none; }
        .input-transition { transition: height 0.2s ease-in-out, border-color 0.2s; }
        
        /* ‰∫§‰∫íÊ†∑Âºè */
        .sidebar-item:hover .more-btn, .more-btn.active { opacity: 1; }
        .sidebar-item.dragging { opacity: 0.5; background: #35373C; }
        .sidebar-item.drag-over { border-top: 2px solid var(--accent-color); }
        
        /* Ê∂àÊÅØÂ∑•ÂÖ∑Ê†è - ÈÄªËæëÈöîÁ¶ª */
        .message-tools { 
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.1s ease-in-out; 
            transform: translateY(4px); 
            background: var(--bg-main); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            border-radius: 4px; 
            z-index: 50; /* Á°Æ‰øùÂú®ÊúÄ‰∏äÂ±Ç */
        }
        @media (hover: hover) {
            .message-item:hover .message-tools { opacity: 1; pointer-events: auto; transform: translateY(0); }
        }
        @media (hover: none) {
            .message-item.mobile-active .message-tools { opacity: 1; pointer-events: auto; transform: translateY(0); }
        }
        
        .reply-link { color: #00b0f4; cursor: pointer; font-weight: 500; font-family: monospace; }
        .reply-link:hover { text-decoration: underline; }
        
        @keyframes flash-highlight { 0% { background-color: rgba(88, 101, 242, 0.3); } 100% { background-color: transparent; } }
        .highlight-flash { animation: flash-highlight 1.5s ease-out; }

        @keyframes textStepIn { 0% { opacity: 0; filter: blur(0px); transform: scale(0.5); } 1% { opacity: 0; filter: blur(0px); transform: scale(1); } 100% { opacity: 1; filter: blur(0); transform: scale(1); } }
        .anim-new-message { display: block; animation: textStepIn 0.3s steps(2, end) forwards; }

        .custom-typography { font-family: Consolas, "Monaco", "Andale Mono", "Ubuntu Mono", monospace; font-size: 15px; font-weight: 400; line-height: 1.5; letter-spacing: 0px; color: var(--text-main); }
        .custom-highlight { background-color: rgba(255, 215, 0, 0.15); color: #FFD700; border: 0px solid #FFD700; border-radius: 2px; padding: 0px 2px; font-weight: normal; margin: 0 1px; vertical-align: baseline; }

        @keyframes pop-in { 0% { opacity: 0; transform: translateY(5px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        .format-toolbar-anim { animation: pop-in 0.1s ease-out forwards; }
        @keyframes slide-up { 0% { transform: translateY(100%); } 100% { transform: translateY(0); } }
        .mobile-toolbar-anim { animation: slide-up 0.2s ease-out forwards; }
        @keyframes slide-in-left { 0% { transform: translateX(-100%); } 100% { transform: translateX(0); } }
        .drawer-enter { animation: slide-in-left 0.2s ease-out forwards; }
        
        /* 2. Âä®ÁîªË°•ÂÖÖ (Êñ∞Â¢û) */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoom-in-95 { from { transform: scale(0.95); } to { transform: scale(1); } }
        @keyframes slide-in-from-right-2 { from { transform: translateX(0.5rem); } to { transform: translateX(0); } }
        @keyframes slide-in-from-bottom-2 { from { transform: translateY(0.5rem); } to { transform: translateY(0); } }
        
        .backdrop-enter { animation: fade-in 0.2s ease-out forwards; }
        .animate-in { animation-duration: 150ms; animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-in { animation-name: fade-in; }
        .zoom-in-95 { animation-name: zoom-in-95; }
        .slide-in-from-right-2 { animation-name: slide-in-from-right-2; }
        .slide-in-from-bottom-2 { animation-name: slide-in-from-bottom-2; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;
        const { createPortal } = ReactDOM;

        // ==========================================
        // 1. Â∏∏ÈáèÂÆö‰πâ (THEMES) - Êñ∞Â¢û
        // ==========================================
        const THEMES = {
            default: { id: 'default', name: 'Dark Default', icon: 'üåë', colors: { sidebar: "#2B2D31", main: "#313338", input: "#383A40", text: "#DBDEE1", header: "#F2F3F5", accent: "#5865F2" } },
            midnight: { id: 'midnight', name: 'OLED Black', icon: 'üåå', colors: { sidebar: "#18181b", main: "#09090b", input: "#27272a", text: "#a1a1aa", header: "#e4e4e7", accent: "#3b82f6" } },
            mint: { id: 'mint', name: 'Mint Green', icon: 'üåø', colors: { sidebar: "#C0E4C5", main: "#CCEED0", input: "#DFF5E3", text: "#3A523C", header: "#1A2F1C", accent: "#2E7D32" } },
            matrix: { id: 'matrix', name: 'Terminal G', icon: 'üìü', colors: { sidebar: "#021a08", main: "#000000", input: "#042f0e", text: "#a3e6a7", header: "#00ff41", accent: "#00ff41" } },
            paper: { id: 'paper', name: 'Clean Paper', icon: 'üìù', colors: { sidebar: "#F7F7F5", main: "#FFFFFF", input: "#F0F0F0", text: "#4D4B45", header: "#37352F", accent: "#EA4C89" } }
        };

        const STORAGE_KEY = 'between_flow_db_v3'; 
        // ‰øÆÊîπ COLORS Â∏∏Èáè‰ª•‰ΩøÁî® CSS ÂèòÈáè
        const COLORS = { sidebarLight: 'var(--bg-sidebar)', chatBackground: 'var(--bg-main)', chatHeader: 'var(--bg-main)', inputBackground: 'var(--bg-input)', userText: 'var(--text-header)', bodyText: 'var(--text-main)', timestamp: 'var(--timestamp)' };
        const ROLE_COLORS = [ { id: 'default', color: '#F2F3F5', name: 'Default', desc: 'Neutral thought' }, { id: 'critic', color: '#ED4245', name: 'Critic', desc: 'Questioning/Doubts' }, { id: 'solver', color: '#2ECC71', name: 'Solver', desc: 'Solution/Insight' }, { id: 'idea', color: '#F1C40F', name: 'Idea', desc: 'Spark/Brainstorm' }, { id: 'meta', color: '#5865F2', name: 'Meta', desc: 'Structure/Planning' } ];
        const EMOJI_KEYWORDS = { '‚úÖ': 'check tick done yes ok success', '‚ùì': 'question doubt ask', 'üí°': 'idea light bulb smart', 'üóëÔ∏è': 'trash delete remove', '‚ù§Ô∏è': 'love like heart', 'üëç': 'like good yes', 'üî•': 'fire hot', 'üö´': 'no ban stop' };
        const EMOJI_CATEGORIES = [
        {
            name: "Suggested",
            emojis: ["üëç","‚ù§Ô∏è","üòÇ","üî•","üëè","üéâ","ü§î","üëÄ","üòÖ","üôè","üòÆ","üò¢"]
        },
        {
            name: "Smileys & Emotion",
            emojis: [
            "üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","üòÇ","ü§£","üòä","üòá","üôÇ","üôÉ","üòâ","üòå",
            "üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòú","üòù","üòõ","ü´†","ü§™","ü§®",
            "üßê","ü§ì","üòé","ü•∏","ü§©","ü•≥","üòè","üòí","üòû","üòî","üòü","üòï",
            "üôÅ","‚òπÔ∏è","üò£","üòñ","üò´","üò©","ü•∫","üò¢","üò≠","üò§","üò†","üò°",
            "ü§¨","üò≥","ü•µ","ü•∂","üò±","üò®","üò∞","üò•","üòì","ü§ó","ü§î","ü´¢",
            "ü§≠","ü´£","ü§´","üò∂","üò∂‚Äçüå´Ô∏è","üòê","üòë","üò¨","üôÑ","üòØ","üò¶","üòß",
            "üòÆ","üò≤","ü•±","üò¥","ü§§","üò™","üòµ","üòµ‚Äçüí´","ü§ê","ü•¥","ü§¢","ü§Æ"
            ]
        },
        {
            name: "People & Gestures",
            emojis: [
            "üëã","ü§ö","üñêÔ∏è","‚úã","üëå","ü§å","ü§è","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô",
            "üëà","üëâ","üëÜ","üëá","‚òùÔ∏è","üëç","üëé","‚úä","üëä","ü§õ","ü§ú",
            "üëè","üôå","ü´∂","üôè","üí™","ü¶æ","üñï","ü§ù","ü´±","ü´≤"
            ]
        },
        {
            name: "Hearts & Symbols",
            emojis: [
            "‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","‚ù£Ô∏è","üíï",
            "üíû","üíì","üíó","üíñ","üíò","üíù",
            "‚úÖ","‚òëÔ∏è","‚úîÔ∏è","‚ùå","‚ùé","‚ö†Ô∏è","‚ùó","‚ùì","‚ùï","‚ùî",
            "‚≠ê","üåü","‚ú®","üí°","üìå","üìç"
            ]
        },
        {
            name: "Objects & Tech",
            emojis: [
            "üíª","üñ•Ô∏è","‚å®Ô∏è","üñ±Ô∏è","üì±","üì≤","üîã","üîå","üß†","üìé","üìå",
            "üìù","üìÑ","üìÇ","üìÅ","üóÇÔ∏è","üóÉÔ∏è","üîç","üîé","üîí","üîì",
            "‚öôÔ∏è","üß™","üß¨","üìä","üìà","üìâ"
            ]
        },
        {
            name: "Nature & Food",
            emojis: [
            "üî•","üíß","üåä","üåà","‚òÄÔ∏è","üåô","‚≠ê","üåü","üå±","üåø","üçÄ","üå∏","üåº",
            "üçé","üçä","üçã","üçå","üçâ","üçá","üçì","üçí","üçë","ü•ë","ü•¶","ü•ï",
            "üçï","üçî","üçü","üåÆ","üçú","üç£","‚òï","üçµ","üç∫","üç∑"
            ]
        }
        ];
        
        const Icon = ({ path, size = 18, className = "", onClick, style }) => <svg onClick={onClick} style={style} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Icons = {
            // ... Áé∞ÊúâÂõæÊ†á ...
            Hash: (p) => <Icon {...p} path={<><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></>} />,
            Pin: (p) => <Icon {...p} path={<><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Search: (p) => <Icon {...p} path={<><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>} />,
            Maximize: (p) => <Icon {...p} path={<><path d="M15 3h6v6"/><path d="M9 21H3v-6"/><path d="M21 3l-7 7"/><path d="M3 21l7-7"/></>} />,
            Minimize: (p) => <Icon {...p} path={<><path d="M4 14h6v6"/><path d="M20 10h-6V4"/><path d="M14 10l7-7"/><path d="M3 21l7-7"/></>} />,
            MoreVertical: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></>} />,
            Check: (p) => <Icon {...p} path={<><polyline points="20 6 9 17 4 12"/></>} />,
            Trash: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />,
            Edit: (p) => <Icon {...p} path={<><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>} />,
            Smile: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></>} />,
            Reply: (p) => <Icon {...p} path={<><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></>} />,
            Copy: (p) => <Icon {...p} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Github: (p) => <Icon {...p} path={<><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></>} />,
            Menu: (p) => <Icon {...p} path={<><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></>} />,
            Send: (p) => <Icon {...p} path={<><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>} />,
            // --- Êñ∞Â¢ûËÆæÁΩÆÁõ∏ÂÖ≥ÂõæÊ†á ---
            Settings: (p) => <Icon {...p} size={18} path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />,
            ChevronRight: (p) => <Icon {...p} path={<><polyline points="9 18 15 12 9 6"/></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></>} />,
            Alert: (p) => <Icon {...p} path={<><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>} />
        };
        const formatSmartTime = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return isoString; 
            const now = new Date();
            const isToday = date.getDate() === now.getDate() && date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);
            const isYesterday = date.getDate() === yesterday.getDate() && date.getMonth() === yesterday.getMonth() && date.getFullYear() === yesterday.getFullYear();
            const isThisYear = date.getFullYear() === now.getFullYear();
            const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            if (isToday) return timeStr;
            if (isYesterday) return `Yesterday ${timeStr}`;
            if (isThisYear) return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${timeStr}`;
            return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${timeStr}`;
        };
        const exportStreamToMarkdown = (stream, messages) => {
            const yaml = `---
title: ${stream.title}
export_date: ${new Date().toISOString()}
id: ${stream.id}
tags: [linear_thinking_tool]
---

# ${stream.title}
`;
            const body = messages.map(msg => {
                const content = msg.content.replace(/\n/g, '\n   '); 
                const meta = JSON.stringify({ id: msg.id, role: { name: msg.username, color: msg.color }, reactions: msg.reactions, timestamp: msg.timestamp });
                const timeLabel = formatSmartTime(msg.timestamp); 
                return `${msg.index}. **${msg.username}** \`${timeLabel}\` (ISO: ${msg.timestamp})\n   ${content}\n   <!-- meta: ${meta} -->`;
            }).join('\n\n');
            return yaml + '\n' + body;
        };
        const parseMarkdownToStream = (text) => {
            const yamlMatch = text.match(/^---\n([\s\S]*?)\n---/);
            let title = "Imported Stream";
            if (yamlMatch) { const titleMatch = yamlMatch[1].match(/title: (.*)/); if (titleMatch) title = titleMatch[1].trim(); }
            const messages = [];
            const msgRegex = /(\d+)\. \*\*(.*?)\*\* .*?\n([\s\S]*?)<!-- meta: (.*?) -->/g;
            let match;
            const bodyText = text.replace(/^---\n[\s\S]*?\n---\n/, '');
            while ((match = msgRegex.exec(bodyText)) !== null) {
                const [_, indexStr, username, contentRaw, metaStr] = match;
                let meta = {};
                try { meta = JSON.parse(metaStr); } catch(e) {}
                const content = contentRaw.trim().replace(/\n   /g, '\n');
                messages.push({
                    id: meta.id || Date.now() + Math.random(),
                    index: parseInt(indexStr),
                    username: username,
                    color: meta.role?.color || '#F2F3F5',
                    timestamp: meta.timestamp || new Date().toISOString(),
                    content: content,
                    reactions: meta.reactions || [],
                    isSystem: false
                });
            }
            return { title, messages };
        };

        const EmptyState = () => (
            <div className="w-full min-h-full flex flex-col items-center py-10 px-4 md:p-8 text-[var(--timestamp)] select-none opacity-80 hover:opacity-100 transition-opacity my-auto">
                <div className="mb-6 p-4 bg-[var(--bg-sidebar)] rounded-2xl shadow-lg transform rotate-3 shrink-0">
                    <div className="w-12 h-12 border-2 border-[var(--accent-color)] rounded-full flex items-center justify-center">
                        <div className="w-2 h-2 bg-[var(--accent-color)] rounded-full"></div>
                    </div>
                </div>
                <h2 className="text-2xl font-bold text-[var(--text-header)] mb-2 text-center">Welcome to Between Flow</h2>
                <p className="text-sm mb-8 text-center">Start typing to capture your flow.</p>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-lg w-full shrink-0">
                    <div className="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)] shadow-sm hover:border-[var(--accent-color)] transition-colors group"><div className="flex items-center justify-between mb-2"><span className="text-[var(--text-header)] font-semibold text-xs uppercase tracking-wider">Fluid Reordering</span><div className="flex gap-1"><kbd className="px-1.5 py-0.5 bg-[var(--bg-input)] rounded text-[10px] font-mono border border-[var(--border-color)] text-[var(--text-main)]">Alt</kbd><span className="text-xs">+</span><kbd className="px-1.5 py-0.5 bg-[var(--bg-input)] rounded text-[10px] font-mono border border-[var(--border-color)] text-[var(--text-main)]">‚Üë‚Üì</kbd></div></div><p className="text-xs text-[var(--timestamp)]">Move thoughts logically.</p></div>
                    <div className="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)] shadow-sm hover:border-[var(--accent-color)] transition-colors group"><div className="flex items-center justify-between mb-2"><span className="text-[var(--text-header)] font-semibold text-xs uppercase tracking-wider">Geek References</span><div className="flex gap-1"><span className="text-[var(--accent-color)] font-mono text-xs">&gt;&gt;#1</span></div></div><p className="text-xs text-[var(--timestamp)]">Type <span className="font-mono text-[var(--text-main)]">&gt;&gt;#</span> to link other messages.</p></div>
                    <div className="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)] shadow-sm hover:border-[var(--accent-color)] transition-colors group"><div className="flex items-center justify-between mb-2"><span className="text-[var(--text-header)] font-semibold text-xs uppercase tracking-wider">Highlight</span><div className="flex gap-1"><kbd className="px-1.5 py-0.5 bg-[var(--bg-input)] rounded text-[10px] font-mono border border-[var(--border-color)] text-[var(--text-main)]">Ctrl</kbd><span className="text-xs">+</span><kbd className="px-1.5 py-0.5 bg-[var(--bg-input)] rounded text-[10px] font-mono border border-[var(--border-color)] text-[var(--text-main)]">H</kbd></div></div><p className="text-xs text-[var(--timestamp)]">Wrap text in <span className="bg-[#FFD700]/20 text-[#FFD700] px-1 rounded">==highlight==</span>.</p></div>
                    <div className="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)] shadow-sm hover:border-[var(--accent-color)] transition-colors group"><div className="flex items-center justify-between mb-2"><span className="text-[var(--text-header)] font-semibold text-xs uppercase tracking-wider">Dual Input</span><div className="flex gap-1"><kbd className="px-1.5 py-0.5 bg-[var(--bg-input)] rounded text-[10px] font-mono border border-[var(--border-color)] text-[var(--text-main)]">Enter</kbd><span className="text-xs">/</span><kbd className="px-1.5 py-0.5 bg-[var(--bg-input)] rounded text-[10px] font-mono border border-[var(--border-color)] text-[var(--text-main)]">Ctrl+Enter</kbd></div></div><p className="text-xs text-[var(--timestamp)]">Chat vs Editor mode.</p></div>
                     <div className="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)] shadow-sm hover:border-[var(--accent-color)] transition-colors group"><div className="flex items-center justify-between mb-2"><span className="text-[var(--text-header)] font-semibold text-xs uppercase tracking-wider">Data Mastery</span><div className="flex gap-1"><span className="text-[var(--timestamp)] text-xs">Right Click</span></div></div><p className="text-xs text-[var(--timestamp)]">Rename, Pin, Export MD.</p></div>
                     <div className="bg-[var(--bg-sidebar)] p-4 rounded-lg border border-[var(--border-color)] shadow-sm hover:border-[var(--accent-color)] transition-colors group"><div className="flex items-center justify-between mb-2"><span className="text-[var(--text-header)] font-semibold text-xs uppercase tracking-wider">Reactions</span><div className="flex gap-1"><span className="text-[var(--timestamp)] text-xs">Hover Msg</span></div></div><p className="text-xs text-[var(--timestamp)]">Add emoji tags.</p></div>
                </div>
            </div>
        );

        // ==========================================
        // 2. SettingsPopup ÁªÑ‰ª∂ (Êñ∞Â¢û)
        // ==========================================
        const SettingsPopup = ({ isOpen, onClose, activeThemeId, onThemeSelect, onClearAll }) => {
            const [view, setView] = useState('menu');
            const [confirmInput, setConfirmInput] = useState("");
            if (!isOpen) return null;

            const currentTheme = THEMES[activeThemeId] || THEMES.default;
            const isResetConfirmed = confirmInput.trim().toUpperCase() === "RESET";

            const handleInnerClose = () => {
                onClose();
                setTimeout(() => { setView('menu'); setConfirmInput(""); }, 200);
            };

            return createPortal(
                // ‰Ωç‰∫é‰æßËæπÊ†èÂ∫ïÈÉ®Â∑¶‰æß
                <div className="fixed bottom-12 left-4 w-60 bg-[var(--bg-sidebar)] border border-[var(--border-color)] rounded-lg shadow-2xl z-[9999] overflow-hidden animate-in fade-in zoom-in-95 duration-100">
                    {/* ‰∏ªËèúÂçïËßÜÂõæ */}
                    {view === 'menu' && (
                        <div className="p-1.5 space-y-0.5">
                            <div className="px-2 py-1.5"><span className="text-[10px] font-bold text-gray-500 uppercase tracking-widest opacity-60">Control Panel</span></div>
                            
                            {/* ‰∏ªÈ¢òÈÄâÈ°π */}
                            <button onClick={() => setView('themes')} className="w-full flex items-center gap-3 px-2.5 py-2 hover:bg-[var(--bg-input)] rounded-md transition-colors group">
                                <span className="text-sm shrink-0 opacity-80">{currentTheme.icon}</span>
                                <div className="flex-1 text-left min-w-0"><span className="text-[11px] font-bold text-[var(--text-header)] truncate">{currentTheme.name}</span></div>
                                <div className="text-gray-500 group-hover:translate-x-0.5 transition-transform opacity-40"><Icons.ChevronRight size={14}/></div>
                            </button>
                            
                            <div className="h-[1px] bg-[var(--border-color)] my-1 mx-1 opacity-50"></div>
                            
                            {/* Ê∏ÖÈô§ÁºìÂ≠òÈÄâÈ°π */}
                            <button onClick={() => setView('clear')} className="w-full flex items-center gap-3 px-2.5 py-2 hover:bg-red-500/10 rounded-md transition-colors text-red-500/80 hover:text-red-500">
                                <Icons.Alert size={14} /><span className="text-[11px] font-bold">Clear Cache</span>
                            </button>
                        </div>
                    )}

                    {/* ‰∏ªÈ¢òÈÄâÊã©ËßÜÂõæ */}
                    {view === 'themes' && (
                        <div className="p-1.5 animate-in slide-in-from-right-2 duration-150">
                            <button onClick={() => setView('menu')} className="flex items-center gap-2 px-2 py-1.5 text-[9px] font-bold text-[var(--text-main)] uppercase tracking-widest hover:opacity-60 mb-1"><Icons.ArrowLeft size={12}/> Back</button>
                            <div className="space-y-0.5 max-h-64 overflow-y-auto custom-scrollbar">
                                {Object.values(THEMES).map(t => (
                                    <button key={t.id} onClick={() => { onThemeSelect(t.id); setView('menu'); }} className={`flex items-center w-full px-2.5 py-1.5 rounded-md transition-all ${activeThemeId === t.id ? 'bg-[var(--bg-input)] text-[var(--text-header)] ring-1 ring-[var(--accent-color)]' : 'hover:bg-[var(--bg-input)] text-[var(--text-main)] opacity-70 hover:opacity-100'}`}>
                                        <span className="mr-3 text-sm">{t.icon}</span><span className="text-[11px] font-bold flex-1 text-left">{t.name}</span>
                                        {activeThemeId === t.id && <div className="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></div>}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Ê∏ÖÈô§ÁºìÂ≠òÁ°ÆËÆ§ËßÜÂõæ */}
                    {view === 'clear' && (
                        <div className="p-3 animate-in slide-in-from-bottom-2 duration-200">
                            <div className="flex items-center gap-2 text-red-500 mb-2"><Icons.Alert size={14} /><span className="text-xs font-bold uppercase tracking-tight text-red-500">Warning</span></div>
                            <p className="text-[10px] text-gray-500 leading-normal mb-4">Wipe all thinking streams locally. This cannot be undone.</p>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-[9px] text-gray-500 font-bold uppercase block mb-1">Type RESET to confirm</label>
                                    <input type="text" value={confirmInput} onChange={(e) => setConfirmInput(e.target.value)} className={`w-full bg-[var(--bg-input)] border rounded px-2 py-1.5 text-xs text-[var(--text-header)] outline-none transition-colors ${isResetConfirmed ? 'border-red-500 ring-1 ring-red-500/30' : 'border-[var(--border-color)] focus:border-gray-500'}`} placeholder="reset" autoFocus />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setView('menu')} className="flex-1 py-1.5 rounded bg-gray-500/10 hover:bg-gray-500/20 text-[10px] font-bold">Cancel</button>
                                    <button disabled={!isResetConfirmed} onClick={onClearAll} className={`flex-1 py-1.5 rounded text-[10px] font-bold transition-all ${isResetConfirmed ? 'bg-red-500 text-white shadow-lg' : 'bg-red-500/20 text-red-500/40 cursor-not-allowed'}`}>Reset All</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="fixed inset-0 z-[-1]" onClick={handleInnerClose}></div>
                </div>,
                document.body
            );
        };

        const SelectionToolbar = ({ visible, position, mode, onFormat }) => {
            if (!visible) return null;
            return createPortal(
                mode === 'pc' ? (
                    <div className="format-toolbar-anim fixed z-[9999] bg-[#111214] border border-[#2B2D31] rounded-lg shadow-xl flex items-center p-1 text-[#DBDEE1]" style={{ top: position.y - 45, left: position.x - 40 }} onMouseDown={(e) => e.preventDefault()}>
                        {onFormat.type === 'read' ? (
                            <button className="p-1.5 hover:bg-[#35373C] rounded transition-colors text-sm font-bold flex items-center" onClick={() => onFormat('copy')}><Icons.Copy size={14} className="mr-1"/> Copy</button>
                        ) : (
                            <>
                                <button className="p-1.5 hover:bg-[#35373C] rounded transition-colors text-sm font-bold" onClick={() => onFormat('bold')}>B</button>
                                <button className="p-1.5 hover:bg-[#35373C] rounded transition-colors text-sm font-bold text-yellow-400" onClick={() => onFormat('highlight')}>H</button>
                            </>
                        )}
                        <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-[#2B2D31]"></div>
                    </div>
                ) : (
                    <div className="mobile-toolbar-anim fixed bottom-0 left-0 right-0 bg-[#232428] border-t border-[#1E1F22] p-2 flex justify-center gap-6 z-[9999] text-[#DBDEE1]" onMouseDown={(e) => e.preventDefault()}>
                        {onFormat.type === 'read' ? (
                            <button className="p-3 bg-[#313338] rounded-xl active:bg-[#404249] font-bold min-w-[80px] flex justify-center items-center" onClick={() => onFormat('copy')}><Icons.Copy size={20}/></button>
                        ) : (
                            <>
                                <button className="p-3 bg-[#313338] rounded-xl active:bg-[#404249] font-bold min-w-[60px]" onClick={() => onFormat('bold')}>B</button>
                                <button className="p-3 bg-[#313338] rounded-xl active:bg-[#404249] font-bold text-yellow-400 min-w-[60px]" onClick={() => onFormat('highlight')}>H</button>
                            </>
                        )}
                    </div>
                ),
                document.body
            );
        };

        const EmojiPickerModal = ({ isOpen, onClose, onSelect }) => {
        const [searchVal, setSearchVal] = useState("");

        const filteredCategories = useMemo(() => {
            const term = searchVal.trim().toLowerCase();
            if (!term) return EMOJI_CATEGORIES;
            return EMOJI_CATEGORIES.map(category => ({
            name: category.name,
            emojis: category.emojis.filter(
                emoji =>
                emoji.includes(term) ||
                (EMOJI_KEYWORDS[emoji] || "").toLowerCase().includes(term)
            )
            })).filter(category => category.emojis.length > 0);
        }, [searchVal]);

        useEffect(() => {
        if (!isOpen) return;

        const handleKeyDown = (e) => {
            if (e.key === "Escape") {
            onClose();
            }
        };

        window.addEventListener("keydown", handleKeyDown);
        return () => {
            window.removeEventListener("keydown", handleKeyDown);
        };
        }, [isOpen, onClose]);


        if (!isOpen) return null;

        return createPortal(
            <div
            className="fixed inset-0 z-[9998]"
            onPointerDown={() => onClose()}
            >
            <div
                className="emoji-picker-modal fixed right-4 top-20 w-80 h-[500px] bg-[var(--bg-sidebar)] border border-[var(--border-color)] rounded-lg shadow-2xl z-[9999] flex flex-col animate-in fade-in zoom-in-95 duration-100"
                onPointerDown={(e) => e.stopPropagation()}
                onClick={(e) => e.stopPropagation()}
            >
                <div className="p-3 bg-[var(--bg-sidebar)] border-b border-[var(--border-color)] rounded-t-lg">
                <div className="relative">
                    <input
                    type="text"
                    placeholder="Search."
                    className="w-full bg-[var(--bg-input)] text-[var(--text-main)] text-xs rounded px-2 py-1.5 pl-8 focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)]"
                    value={searchVal}
                    onChange={(e) => setSearchVal(e.target.value)}
                    autoFocus
                    />
                    <Icons.Search
                    size={14}
                    className="absolute left-2 top-2 text-[var(--timestamp)]"
                    />
                </div>
                </div>

                <div className="flex-1 overflow-y-auto custom-scrollbar p-2">
                {filteredCategories.map((category) => (
                    <div key={category.name} className="mb-4">
                    <div className="text-[11px] font-bold text-[var(--timestamp)] uppercase mb-2 ml-1 tracking-wider bg-[var(--bg-sidebar)] sticky top-0 py-1 z-10">
                        {category.name}
                    </div>

                    <div className="grid grid-cols-8 gap-1">
                        {category.emojis.map((emoji) => (
                        <div
                            key={emoji}
                            className="text-xl cursor-pointer hover:bg-[var(--bg-input)] rounded p-1 flex justify-center items-center h-8 w-8 transition-colors"
                            onClick={() => onSelect(emoji)}
                            title={EMOJI_KEYWORDS[emoji] || ""}
                        >
                            {emoji}
                        </div>
                        ))}
                    </div>
                    </div>
                ))}
                </div>
            </div>
            </div>,
            document.body
        );
        };




        const ReplyPreview = ({ index, content }) => (
            <div className="absolute left-0 bottom-full mb-1 w-64 bg-[#18191C] border border-[#26272D] rounded shadow-xl p-2 z-50 pointer-events-none text-xs">
                <div className="flex items-center text-[#949BA4] mb-1 font-mono"><span className="text-[#5865F2]">>>#{index}</span></div>
                <div className="text-[#DBDEE1] line-clamp-3">{content}</div>
            </div>
        );

        const MessageContent = ({ content, allMessages, onJumpTo, shouldAnimate, onSelection }) => {
            const parts = content.split(/(\>\>#\d+|==[\s\S]+?==|\*\*[\s\S]+?\*\*)/g); 
            const handleMouseUp = (e) => {
                const sel = window.getSelection();
                if (!sel.isCollapsed && sel.toString().length > 0) {
                    const isMobile = window.innerWidth < 768;
                    onSelection({ show: true, x: e.clientX, y: e.clientY, isMobile, type: 'read', text: sel.toString() });
                }
            };
            return (
                <div className={`custom-typography whitespace-pre-wrap ${shouldAnimate ? 'anim-new-message' : ''} cursor-text select-text`} style={{ color: COLORS.bodyText }} onMouseUp={handleMouseUp}>
                    {parts.map((part, i) => {
                        const refMatch = part.match(/^>>#(\d+)$/);
                        if (refMatch) {
                            const targetIndex = parseInt(refMatch[1]);
                            const targetMsg = allMessages.find(m => m.index === targetIndex);
                            return (
                                <div key={i} className="reply-click-target relative group/reply inline-block align-middle mx-0.5 select-none cursor-pointer" onClick={(e) => { e.stopPropagation(); onJumpTo(targetIndex); }}>
                                    <span className="text-[10px] uppercase font-bold text-slate-300 border border-slate-500 px-1.5 py-px rounded-[4px] leading-tight hover:bg-slate-700 hover:border-slate-400 transition-colors">#{targetIndex}</span>
                                    {targetMsg && <div className="hidden group-hover/reply:block"><ReplyPreview index={targetIndex} content={targetMsg.content} /></div>}
                                </div>
                            );
                        }
                        if (part.startsWith('==') && part.endsWith('==') && part.length >= 4) { return <span key={i} className="custom-highlight">{part.slice(2, -2)}</span>; }
                        if (part.startsWith('**') && part.endsWith('**') && part.length >= 4) { return <strong key={i} className="font-bold text-white">{part.slice(2, -2)}</strong>; }
                        return part;
                    })}
                </div>
            );
        };

        const Message = ({ 
            id, index, username, timestamp, content, color = '#F2F3F5', isSystem, reactions = [], 
            quickReactions, onToggleReaction, onOpenFullPicker, onAction, 
            isHighlighted, allMessages, onJumpTo, isEditing, onEditSave, onEditCancel,
            isSelected, onSelect, shouldAnimate,
            onGlobalSelection
        }) => {
            const [editVal, setEditVal] = useState(content);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const editRef = useRef(null);
            const menuRef = useRef(null);
			const menuBtnRef = useRef(null); 

            useEffect(() => {
                if (isEditing && editRef.current) {
                    editRef.current.style.height = 'auto';
                    editRef.current.style.height = editRef.current.scrollHeight + 'px';
                    editRef.current.focus();
                    setEditVal(content); 
                }
            }, [isEditing, content]);


			useEffect(() => {
			  if (!isMenuOpen) return;

			  const handleClose = (e) => {
				const t = e.target;
				const inMenu = menuRef.current?.contains(t);
				const inBtn = menuBtnRef.current?.contains(t);
				if (!inMenu && !inBtn) setIsMenuOpen(false);
			  };

			  document.addEventListener('pointerdown', handleClose, true);
			  return () => document.removeEventListener('pointerdown', handleClose, true);
			}, [isMenuOpen]);


            const handleMouseUp = (e) => {
                if (!isEditing || !editRef.current) return;
                const textarea = editRef.current;
                if (textarea.selectionStart !== textarea.selectionEnd) {
                    const isMobile = window.innerWidth < 768;
                    onGlobalSelection({ show: true, x: e.clientX, y: e.clientY, isMobile, type: 'edit', onFormat: (type) => handleFormat(type, textarea) });
                }
            };

            const handleFormat = (type, textarea) => {
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value; 
                const selectedText = text.substring(start, end);
                let wrap = type === 'bold' ? '**' : '==';
                let newText = text.substring(0, start) + wrap + selectedText + wrap + text.substring(end);
                setEditVal(newText);
                onGlobalSelection({ show: false });
                setTimeout(() => { textarea.focus(); textarea.setSelectionRange(start + wrap.length, end + wrap.length); }, 0);
            };

            const handleEditKeyDown = (e) => {
                if (e.key === 'Escape') onEditCancel();
                if (e.key === 'Enter') {
                    if (e.ctrlKey || e.metaKey) { e.preventDefault(); onEditSave(id, editVal); }
                    else if (!editVal.includes('\n')) { e.preventDefault(); onEditSave(id, editVal); }
                }
            };

            const displayTime = formatSmartTime(timestamp);
            
            // FIX: isMobile Detection to fix hover/click logic
            const isMobile = window.innerWidth < 768;
            const isMenuVisible = isMenuOpen || (isMobile ? isSelected : false); // Force menu open if mobile selected

            return (
            <div
                id={`msg-${index}`}
                className={`message-item group flex mt-[2px] mb-[2px] hover:bg-[var(--bg-input)] relative pr-12 ${isHighlighted ? 'highlight-flash' : ''} ${isSelected ? 'selected mobile-active' : ''}`}
                onClick={onSelect}
            >
                {!isEditing && (
                <div
                    className={`message-tools absolute right-4 -top-4 flex items-center z-10 px-1 py-0.5 space-x-0.5 ${isMenuVisible ? 'opacity-100 pointer-events-auto translate-y-0' : ''}`}
                >
                    {quickReactions.map((emoji) => (
                    <div
                        key={emoji}
                        className="p-1.5 text-lg hover:bg-[#404249] cursor-pointer rounded transition-colors hover:scale-110 active:scale-95"
                        onClick={(e) => {
                        e.stopPropagation();
                        onToggleReaction(id, emoji);
                        }}
                    >
                        {emoji}
                    </div>
                    ))}

                    <div className="w-[1px] h-4 bg-[#3F4147] mx-1"></div>

                    <div
                    className="p-1.5 text-[#B5BAC1] hover:text-[#DBDEE1] hover:bg-[#404249] cursor-pointer rounded transition-colors"
                    onClick={(e) => {
                        e.stopPropagation();
                        onOpenFullPicker(id);
                    }}
                    title="More Reactions"
                    >
                    <Icons.Plus size={16} />
                    </div>

                    <div className="relative">
                    <div
                        ref={menuBtnRef}
                        className={`p-1.5 text-[#B5BAC1] hover:text-[#DBDEE1] hover:bg-[#404249] cursor-pointer rounded transition-colors ${isMenuOpen ? 'bg-[#404249] text-[#DBDEE1]' : ''}`}
                        onClick={(e) => {
                        e.stopPropagation();
                        setIsMenuOpen(!isMenuOpen);
                        }}
                    >
                        <Icons.MoreVertical size={16} />
                    </div>

                    {isMenuOpen &&
                        createPortal(
                        <div
                            ref={menuRef}
                            className="fixed z-[9999] bg-[#111214] border border-[#1E1F22] rounded shadow-xl flex flex-col py-1 animate-in fade-in zoom-in-95 duration-75"
                            style={{
                            top: menuBtnRef.current?.getBoundingClientRect().bottom + 5 || 0,
                            left: (menuBtnRef.current?.getBoundingClientRect().left || 0) - 100,
                            width: '8rem',
                            }}
                        >
                            <div
                            className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#5865F2] hover:text-white text-[#DBDEE1]"
                            onClick={() => {
                                onAction('reply', id, index);
                                setIsMenuOpen(false);
                            }}
                            >
                            <Icons.Reply size={12} className="mr-2" /> Reply
                            </div>

                            <div
                            className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#5865F2] hover:text-white text-[#DBDEE1]"
                            onClick={() => {
                                onAction('edit', id);
                                setIsMenuOpen(false);
                            }}
                            >
                            <Icons.Edit size={12} className="mr-2" /> Edit
                            </div>

                            <div
                            className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#5865F2] hover:text-white text-[#DBDEE1]"
                            onClick={() => {
                                onAction('copy', id, index, content);
                                setIsMenuOpen(false);
                            }}
                            >
                            <Icons.Copy size={12} className="mr-2" /> Copy
                            </div>

                            <div className="h-[1px] bg-[#3F4147] my-1"></div>

                            <div
                            className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#DA373C] hover:text-white text-[#DBDEE1]"
                            onClick={() => {
                                onAction('delete', id);
                                setIsMenuOpen(false);
                            }}
                            >
                            <Icons.Trash size={12} className="mr-2" /> Delete
                            </div>

                            <div
                            className="fixed inset-0 z-[-1]"
                            onClick={() => setIsMenuOpen(false)}
                            ></div>
                        </div>,
                        document.body
                        )}
                    </div>
                </div>
                )}

                <div
                className="w-[60px] shrink-0 text-right pr-4 py-[6px] gutter-cell text-[13px] opacity-70 group-hover:opacity-100 transition-opacity"
                style={{ color: color }}
                >
                {index}
                </div>

                <div className="flex-1 min-w-0 py-[2px] pr-4">
                <div className="flex items-baseline">
                    <span
                    className="font-medium mr-2 hover:underline cursor-pointer text-[14px]"
                    style={{ color: color }}
                    >
                    {username}
                    </span>

                    {isSystem && (
                    <span className="bg-[#5865F2] text-white text-[10px] px-1 rounded-[4px] mr-2 flex items-center h-[15px] uppercase font-bold">
                        BOT
                    </span>
                    )}

                    <span
                    className="text-[11px] font-medium"
                    style={{ color: COLORS.timestamp }}
                    title={timestamp}
                    >
                    {displayTime}
                    </span>
                </div>

                {isEditing ? (
                    <div
                    className="mt-1 bg-[var(--bg-input)] rounded p-2"
                    onClick={(e) => e.stopPropagation()}
                    >
                    <textarea
                        ref={editRef}
                        className="w-full bg-transparent border-none outline-none custom-typography resize-none overflow-hidden"
                        value={editVal}
                        onChange={(e) => setEditVal(e.target.value)}
                        onKeyDown={handleEditKeyDown}
                        onMouseUp={handleMouseUp}
                    />
                    <div className="text-[10px] text-[var(--timestamp)] mt-2 flex justify-end gap-2">
                        <span>Esc to cancel</span>
                        <span>‚Ä¢</span>
                        <span>Enter to save</span>
                    </div>
                    </div>
                ) : (
                    <MessageContent
                    content={content}
                    allMessages={allMessages}
                    onJumpTo={onJumpTo}
                    shouldAnimate={shouldAnimate}
                    onSelection={(state) =>
                        onGlobalSelection({
                        ...state,
                        onFormat: (type) => {
                            if (type === 'copy') {
                            navigator.clipboard.writeText(state.text);
                            onGlobalSelection({ show: false });
                            }
                        },
                        })
                    }
                    />
                )}

                {reactions.length > 0 && !isEditing && (
                    <div className="flex flex-wrap gap-1 mt-1">
                    {reactions.map((emoji) => (
                        <div
                        key={emoji}
                        className="flex items-center bg-[var(--bg-sidebar)] hover:bg-[#35373C] border border-transparent hover:border-[#404249] rounded-[4px] px-1.5 py-0.5 cursor-pointer transition-colors"
                        onClick={(e) => {
                            e.stopPropagation();
                            onToggleReaction(id, emoji);
                        }}
                        >
                        <span className="text-sm">{emoji}</span>
                        <span className="text-[10px] text-[#B5BAC1] ml-1 font-bold">1</span>
                        </div>
                    ))}
                    </div>
                )}
                </div>
            </div>
            );
        }
        const SidebarItem = ({ stream, isActive, onClick, onMenuAction, onMove }) => {
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isDragging, setIsDragging] = useState(false);
            const [isDragOver, setIsDragOver] = useState(false);
            const menuRef = useRef(null);
            const buttonRef = useRef(null); // Ref for portal positioning

            useEffect(() => {
                const handleClickOutside = (e) => { if (menuRef.current && !menuRef.current.contains(e.target)) setIsMenuOpen(false); };
                document.addEventListener("mousedown", handleClickOutside); return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleDrop = (e) => { e.preventDefault(); setIsDragOver(false); const draggedId = e.dataTransfer.getData("text/plain"); if (draggedId && draggedId !== stream.id && stream.isPinned) onMove(draggedId, stream.id); };

            return (
                <div className={`sidebar-item group relative flex items-center px-2 py-[6px] rounded cursor-pointer mb-[2px] ${isActive ? 'bg-[#3F4147] text-white' : 'text-[var(--timestamp)] hover:bg-[#35373C] hover:text-[var(--text-main)]'} ${isDragging ? 'dragging' : ''} ${isDragOver ? 'drag-over' : ''}`} onClick={onClick} draggable={stream.isPinned} onDragStart={(e) => { if (!stream.isPinned) return; e.dataTransfer.setData("text/plain", stream.id); setIsDragging(true); }} onDragEnd={() => { setIsDragging(false); setIsDragOver(false); }} onDragOver={(e) => { if (stream.isPinned) { e.preventDefault(); setIsDragOver(true); } }} onDragLeave={() => setIsDragOver(false)} onDrop={handleDrop}>
                    {stream.isPinned ? <Icons.Pin size={18} className="mr-2 text-[var(--text-main)] cursor-move" /> : <Icons.Hash size={18} className="mr-2 opacity-70" />}
                    <span className="font-medium text-[14px] truncate flex-1">{stream.title}</span>
                    <div ref={buttonRef} className={`more-btn p-1 rounded hover:bg-[#232428] opacity-0 transition-opacity ${isMenuOpen ? 'active' : ''}`} onClick={(e) => { e.stopPropagation(); setIsMenuOpen(!isMenuOpen); }}><Icons.MoreVertical size={16} /></div>
                    
                    {isMenuOpen && createPortal(
                        <div 
							ref={menuRef}
                            className="fixed z-[9999] bg-[#111214] border border-[#1E1F22] rounded shadow-xl flex flex-col py-1 animate-in fade-in zoom-in-95 duration-75"
                            style={{ 
                                top: buttonRef.current?.getBoundingClientRect().bottom + 5 || 0, 
                                left: (buttonRef.current?.getBoundingClientRect().left || 0) + 20,
                                width: '8rem'
                            }}
                        >
                            <div className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#5865F2] hover:text-white text-[#DBDEE1]" onClick={(e) => { e.stopPropagation(); onMenuAction('rename', stream.id); setIsMenuOpen(false); }}><Icons.Edit size={12} className="mr-2" /> Rename</div>
                            <div className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#5865F2] hover:text-white text-[#DBDEE1]" onClick={(e) => { e.stopPropagation(); onMenuAction('export', stream.id); setIsMenuOpen(false); }}><Icons.Upload size={12} className="mr-2" /> Export .md</div>
                            <div className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#5865F2] hover:text-white text-[#DBDEE1]" onClick={(e) => { e.stopPropagation(); onMenuAction('togglePin', stream.id); setIsMenuOpen(false); }}><Icons.Pin size={12} className="mr-2" /> {stream.isPinned ? 'Unpin' : 'Pin'}</div>
                            <div className="h-[1px] bg-[#3F4147] my-1 mx-2"></div>
                            <div className="px-2 py-1.5 text-xs flex items-center cursor-pointer hover:bg-[#DA373C] hover:text-white text-[#DBDEE1]" onClick={(e) => { e.stopPropagation(); onMenuAction('delete', stream.id); setIsMenuOpen(false); }}><Icons.Trash size={12} className="mr-2" /> Delete</div>
                            <div className="fixed inset-0 z-[-1]" onClick={() => setIsMenuOpen(false)}></div>
                        </div>,
                        document.body
                    )}
                </div>
            );
        };

        // ‰øÆÊîπ Sidebar ÁªÑ‰ª∂‰ª•ÂåÖÂê´ËÆæÁΩÆÂ∫ïÈÉ®
        const Sidebar = ({ streams, activeStreamId, onSelect, onCreate, onImport, onMenuAction, onMovePinned, isOpen, onClose, activeThemeId, onThemeSelect, onClearAll }) => {
            const sortedStreams = useMemo(() => {
                const pinned = streams.filter(s => s.isPinned).sort((a, b) => (a.pinOrder || 0) - (b.pinOrder || 0));
                const recent = streams.filter(s => !s.isPinned).sort((a, b) => b.lastUpdated - a.lastUpdated);
                return { pinned, recent };
            }, [streams]);
            
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const fileInputRef = useRef(null);
            const handleImportClick = (e) => { e.stopPropagation(); fileInputRef.current.click(); };
            const handleFileChange = (e) => { if (e.target.files[0]) { onImport(e.target.files[0]); e.target.value = null; } };

            return (
                <>
                    {/* Backdrop for Mobile */}
                    {isOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-enter" onClick={onClose}></div>}
                    
                    {/* Sidebar Container */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-60 bg-[var(--bg-sidebar)] flex flex-col border-r border-[var(--border-color)] transform transition-transform duration-200 ease-in-out md:translate-x-0 md:static md:flex ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        {/* Header */}
                        <div className="h-14 border-b border-[var(--border-color)] flex flex-col justify-center px-4 bg-[var(--bg-sidebar)] hover:bg-[#35373C] transition-colors cursor-pointer group shrink-0">
                            <div className="flex items-center justify-between"><span className="font-bold text-[var(--text-header)] text-[15px]">Between Flow</span><span className="text-[10px] bg-[var(--accent-color)] text-white px-1.5 py-0.5 rounded-sm font-bold">V1</span></div>
                            <div className="flex items-center text-[var(--timestamp)] text-[11px] mt-0.5 group-hover:text-[var(--text-main)]"><span className="mr-1 opacity-70"><Icons.Github width="12" height="12"/></span><span>@Betaproteinn</span></div>
                        </div>

                        {/* List */}
                        <div className="flex-1 p-3 overflow-y-auto custom-scrollbar">
                            {sortedStreams.pinned.length > 0 && (
                                <div className="mb-4">
                                    <div className="text-[var(--timestamp)] text-[11px] font-bold px-2 mb-1 flex items-center justify-between"><span>PINNED</span></div>
                                    {sortedStreams.pinned.map(stream => <SidebarItem key={stream.id} stream={stream} isActive={activeStreamId === stream.id} onClick={() => { onSelect(stream.id); onClose(); }} onMenuAction={onMenuAction} onMove={onMovePinned} />)}
                                </div>
                            )}
                            <div className="text-[var(--timestamp)] text-[11px] font-bold px-2 mb-1 flex items-center justify-between group">
                                <div className="cursor-pointer hover:text-[var(--text-main)]" onClick={() => { onCreate(); onClose(); }}>STREAMS</div>
                                <div className="flex space-x-1 opacity-100 transition-opacity"><Icons.Download size={14} className="cursor-pointer hover:text-[var(--text-main)]" onClick={handleImportClick} title="Import .md" /><Icons.Plus size={14} className="cursor-pointer hover:text-[var(--text-main)]" onClick={() => { onCreate(); onClose(); }} title="New Stream" /></div>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".md" />
                            </div>
                            {sortedStreams.recent.map(stream => <SidebarItem key={stream.id} stream={stream} isActive={activeStreamId === stream.id} onClick={() => { onSelect(stream.id); onClose(); }} onMenuAction={onMenuAction} />)}
                        </div>

                        {/* --- Ê†∏ÂøÉÊèêÂèñÈÉ®ÂàÜÔºö‰æßËæπÊ†èÂ∫ïÈÉ®ËÆæÁΩÆÂå∫ --- */}
                        <div className="p-1.5 mt-auto flex items-center border-t border-[var(--border-color)]">
                            <div className="relative inline-block">
                                <button 
                                    onClick={() => setIsSettingsOpen(!isSettingsOpen)} 
                                    className={`w-8 h-8 flex items-center justify-center rounded-md transition-all duration-300 ${isSettingsOpen ? 'text-[var(--text-header)] rotate-90 scale-100 bg-[var(--bg-input)]' : 'text-gray-500 opacity-40 hover:opacity-100 hover:text-[var(--text-header)] hover:bg-[var(--bg-input)]'}`}
                                >
                                    <Icons.Settings />
                                </button>
                                
                                <SettingsPopup 
                                    isOpen={isSettingsOpen} 
                                    onClose={() => setIsSettingsOpen(false)} 
                                    activeThemeId={activeThemeId} 
                                    onThemeSelect={onThemeSelect} 
                                    onClearAll={onClearAll} 
                                />
                            </div>
                            <div className="ml-auto pr-2 flex items-center">
                                <span className="text-[9px] font-mono opacity-20 mr-2 uppercase tracking-tighter text-[var(--text-main)]">v1.7</span>
                                <div className="w-1 h-1 rounded-full bg-green-500/30"></div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        const ChatHeader = ({ title, isPinned, onMenuClick }) => (
            <div className="flex-none h-12 px-4 flex items-center z-10 bg-[var(--bg-main)] border-b border-[var(--border-color)] sticky top-0">
                <div className="flex items-center text-[var(--text-header)] font-bold truncate">
                    <div className="mr-3 md:hidden cursor-pointer text-[var(--timestamp)] hover:text-[var(--text-main)]" onClick={onMenuClick}><Icons.Menu size={20} /></div>
                    {isPinned ? <Icons.Pin size={20} className="text-[var(--timestamp)] mr-2" /> : <Icons.Hash size={20} className="text-[var(--timestamp)] mr-2" />}{title || "Select a stream"}
                </div>
                <div className="relative hidden sm:block ml-auto"><input type="text" placeholder="Search..." className="bg-[var(--bg-input)] text-xs text-[var(--text-main)] rounded px-2 py-1 pl-2 w-48 focus:outline-none placeholder-[var(--timestamp)]" /><Icons.Search size={14} className="absolute right-2 top-1.5 text-[var(--timestamp)]" /></div>
            </div>
        );

        const ThinkingInput = ({ onSend, nextIndex, replyTo, onClearReply, inputRef, onGlobalSelection }) => {
            const [val, setVal] = useState("");
            const [isLong, setIsLong] = useState(false);
            const [role, setRole] = useState(ROLE_COLORS[0]);
            const [showPicker, setShowPicker] = useState(false);
            const internalRef = useRef(null);
            const textareaRef = inputRef || internalRef;
            
            useEffect(() => { if (!isLong && textareaRef.current) { textareaRef.current.style.height = 'auto'; textareaRef.current.style.height = Math.min(textareaRef.current.scrollHeight, 120) + 'px'; } }, [val, isLong]);
            useEffect(() => { if (replyTo) { setVal(prev => prev + `>>#${replyTo} `); textareaRef.current?.focus(); onClearReply(); } }, [replyTo, onClearReply]);
            
            const handleMouseUp = (e) => {
                const textarea = textareaRef.current;
                if (!textarea) return;
                if (textarea.selectionStart !== textarea.selectionEnd) {
                    const isMobile = window.innerWidth < 768;
                    onGlobalSelection({ show: true, x: e.clientX, y: e.clientY, isMobile, type: 'edit', onFormat: (type) => handleFormat(type, textarea) });
                }
            };
            const handleFormat = (type, textarea) => {
                if (!textarea) return;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = val;
                const selectedText = text.substring(start, end);
                let wrap = type === 'bold' ? '**' : '==';
                let newText = text.substring(0, start) + wrap + selectedText + wrap + text.substring(end);
                setVal(newText);
                onGlobalSelection({ show: false });
                setTimeout(() => { textarea.focus(); textarea.setSelectionRange(start + wrap.length, end + wrap.length); }, 0);
            };
            const handleKeyDown = (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'h') { e.preventDefault(); handleFormat('highlight', textareaRef.current); return; }
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') { e.preventDefault(); handleFormat('bold', textareaRef.current); return; }
                if (isLong) { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); doSend(); } }
                else { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); doSend(); } }
            };
            const doSend = () => { if (val.trim()) { onSend(val, role); setVal(""); } };
            
            // FIX: Added explicit sticky bottom
            return (
                <div 
                    className="flex-none sticky bottom-0 left-0 right-0 px-4 pb-6 pt-2 z-20 bg-[var(--bg-main)]"
                    style={{ paddingBottom: 'calc(env(safe-area-inset-bottom) + 1.5rem)' }}
                >
                    {showPicker && <div className="absolute bottom-[calc(100%-10px)] left-4 mb-2 bg-[var(--bg-sidebar)] border border-[var(--border-color)] rounded-lg shadow-xl p-2 flex flex-col gap-1 w-48 animate-in fade-in slide-in-from-bottom-2 duration-100">{ROLE_COLORS.map(r => <div key={r.id} className={`flex items-center p-2 rounded hover:bg-[#404249] cursor-pointer ${role.id === r.id ? 'bg-[#35373C]' : ''}`} onClick={() => { setRole(r); setShowPicker(false); }}><div className="w-4 h-4 rounded-full mr-3 border border-white/10" style={{ backgroundColor: r.color }}></div><div className="flex flex-col"><span className="text-xs font-bold text-[var(--text-header)]">{r.name}</span><span className="text-[10px] text-[var(--timestamp)]">{r.desc}</span></div>{role.id === r.id && <Icons.Check size={14} className="ml-auto text-white" />}</div>)}</div>}
                    <div className="input-transition rounded-lg flex flex-col px-4 py-2 bg-[var(--bg-input)] border transition-colors duration-200" style={{ height: isLong ? '300px' : 'auto', borderColor: role.id !== 'default' ? role.color : 'transparent' }}>
                        <div className={`flex w-full ${isLong ? 'items-start flex-1 overflow-hidden' : 'items-center'}`}>
                            <div className={`mr-3 cursor-pointer hover:opacity-80 transition-transform active:scale-95 shrink-0 ${isLong ? 'mt-[6px]' : ''}`} onClick={() => setShowPicker(!showPicker)} title="Change Role"><div className="w-5 h-5 rounded-full shadow-sm border border-white/10" style={{ backgroundColor: role.color }}></div></div>
                            <textarea ref={textareaRef} className={`flex-1 bg-transparent border-none outline-none custom-typography resize-none custom-scrollbar ${isLong ? 'h-full overflow-y-auto' : 'overflow-hidden'}`} placeholder={isLong ? `Writing as ${role.name}...` : `Message #${nextIndex}... (Enter to send)`} value={val} onChange={(e) => setVal(e.target.value)} onKeyDown={handleKeyDown} onMouseUp={handleMouseUp} rows={1} style={{ height: isLong ? '100%' : 'auto' }} />
                            {/* Mobile Send Button */}
                            <div className="md:hidden ml-2 text-[var(--accent-color)] cursor-pointer p-1 active:bg-[#404249] rounded transition-colors shrink-0" onClick={doSend}><Icons.Send size={20} /></div>
                            {/* Desktop Mode Toggle */}
                            <div className={`hidden md:block ml-2 text-[#B5BAC1] hover:text-[#F2F3F5] cursor-pointer p-1 rounded hover:bg-[#404249] transition-colors shrink-0 ${isLong ? 'mt-[2px]' : ''}`} onClick={() => setIsLong(!isLong)}>{isLong ? <Icons.Minimize size={18} /> : <Icons.Maximize size={18} />}</div>
                        </div>
                        {isLong && <div className="mt-auto pt-2 border-t border-white/10 flex justify-between items-center text-[11px] text-[var(--timestamp)] shrink-0"><span>Editor Mode</span><div className="flex items-center gap-2"><span>Ctrl + Enter</span><button onClick={doSend} className="px-3 py-1 rounded text-white font-bold text-xs hover:opacity-90" style={{ backgroundColor: role.color === '#F2F3F5' ? '#5865F2' : role.color }}>Send</button></div></div>}
                    </div>
                </div>
            );
        };

        const ChatStream = ({ messages, title, quickReactions, onToggleReaction, onOpenFullPicker, onAction, highlightedId, onJumpTo, editingId, onEditSave, onEditCancel, selectedMsgId, onSelectMsg, onGlobalSelection }) => {
            const scrollRef = useRef(null);
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages.length]);
            
            // --- Empty State Render Logic ---
            if (messages.length === 0) {
                return <div className="flex-1 overflow-y-auto custom-scrollbar flex flex-col"><EmptyState /></div>;
            }

            return (
                // FIX: Flex-1 and overflow auto for correct sticky behavior
                <div className="flex-1 overflow-y-auto custom-scrollbar flex flex-col pb-4" ref={scrollRef}>
                    <div className="mt-auto px-4 pt-6 pb-2 pl-[76px]"> 
                        <h1 className="text-2xl font-bold text-[var(--text-header)] mb-1">{title}</h1>
                        <p className="text-[var(--timestamp)] text-sm">Start of this thinking stream.</p>
                    </div>
                    <div className="w-full h-[1px] bg-[#3F4147] mx-4 my-2 opacity-30"></div>
                    <div className="flex flex-col">
                        {messages.map((msg, i) => (
                            <Message 
                                key={msg.id} 
                                index={i + 1} 
                                {...msg} 
                                quickReactions={quickReactions} 
                                onToggleReaction={onToggleReaction} 
                                onOpenFullPicker={onOpenFullPicker}
                                onAction={onAction}
                                highlightedId={highlightedId}
                                onJumpTo={onJumpTo}
                                isEditing={msg.id === editingId}
                                onEditSave={onEditSave}
                                onEditCancel={onEditCancel}
                                allMessages={messages}
                                isHighlighted={msg.id === highlightedId}
                                isSelected={msg.id === selectedMsgId}
                                onSelect={() => onSelectMsg(msg.id)}
                                shouldAnimate={msg.shouldAnimate}
                                onGlobalSelection={onGlobalSelection}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // MAIN APP
        // ==========================================
        function App() {
            // Initial Data
            const now = new Date();
            const yesterday = new Date(now); yesterday.setDate(now.getDate() - 1);

            const DEFAULT_STREAMS = [
                { id: 's0', title: 'üëã Welcome', isPinned: true, pinOrder: 0, lastUpdated: now.getTime() },
                { id: 's1', title: 'project-alpha', isPinned: true, pinOrder: 1, lastUpdated: 1700000000000 },
                { id: 's2', title: 'design-thoughts', isPinned: false, pinOrder: 0, lastUpdated: 1699999000000 }
            ];

            const DEFAULT_MESSAGES = {
                's0': [
                    { id: 301, index: 1, username: "System", color: "#5865F2", timestamp: now.toISOString(), content: "Welcome to Between Flow! Try selecting this text and press ==Ctrl+B== to bold it, or ==Ctrl+H== to highlight.", isSystem: true, reactions: [] },
                    { id: 302, index: 2, username: "System", color: "#5865F2", timestamp: now.toISOString(), content: "Press ==Alt+Up/Down== to move me up/down! I should be before the System message.", isSystem: true, reactions: [] },
                    { id: 303, index: 3, username: "System", color: "#5865F2", timestamp: now.toISOString(), content: "Use >>#1 to reference the start of this tutorial.", isSystem: true, reactions: ['üí°'] }
                ],
/*    
                's1': [
                    { id: 101, index: 1, username: "Self", color: "#F2F3F5", timestamp: yesterday.toISOString(), content: "Init. Ref >>#2", isSystem: false, reactions: [] },
                    { id: 102, index: 2, username: "Self", color: "#F2F3F5", timestamp: now.toISOString(), content: "Target", isSystem: false, reactions: [] }
                ],
*/
                's2': []
            };

            const loadFromStorage = () => {
                try {
                    const saved = localStorage.getItem('between_flow_db_v3');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        const hasWelcome = parsed.streams.some(s => s.id === 's0');
                        if (!hasWelcome) {
                            parsed.streams = [DEFAULT_STREAMS[0], ...parsed.streams];
                            parsed.streamMessages = { ...DEFAULT_MESSAGES, ...parsed.streamMessages };
                        }
                        if (parsed.streamMessages) {
                          const cleaned = {};
                          for (const [sid, msgs] of Object.entries(parsed.streamMessages)) {
                            cleaned[sid] = (msgs || []).map(m => {
                              const { shouldAnimate, ...rest } = m;
                              return rest;
                            });
                          }
                          parsed.streamMessages = cleaned;
                        }
                        return parsed;
                    }
                } catch (e) { console.error("Load failed", e); }
                return null;
            };

            const savedData = loadFromStorage();
            
            const [streams, setStreams] = useState(savedData ? savedData.streams : DEFAULT_STREAMS);
            const [streamMessages, setStreamMessages] = useState(savedData ? savedData.streamMessages : DEFAULT_MESSAGES);
            const [activeStreamId, setActiveStreamId] = useState(savedData ? savedData.activeStreamId : 's0');
            // Êñ∞Â¢û‰∏ªÈ¢òÁä∂ÊÄÅ
            const [themeId, setThemeId] = useState(savedData?.themeId || 'default');
            
            const [recentEmojis, setRecentEmojis] = useState(['‚úÖ', '‚ùì', 'üí°', 'üóëÔ∏è']);
            const [fullPickerState, setFullPickerState] = useState({ isOpen: false, targetMsgId: null });
            
            const [highlightedId, setHighlightedId] = useState(null);
            const [replyTo, setReplyTo] = useState(null);
            const [editingId, setEditingId] = useState(null);
            const [selectedMsgId, setSelectedMsgId] = useState(null);
            const [globalSelection, setGlobalSelection] = useState({ show: false, x: 0, y: 0, onFormat: null });
            const [sidebarOpen, setSidebarOpen] = useState(false);

            const inputRef = useRef(null);

            const activeStream = streams.find(s => s.id === activeStreamId) || streams[0];
            const messages = streamMessages[activeStreamId] || [];

            useEffect(() => {
                const data = { streams, streamMessages, activeStreamId, themeId }; // ‰øùÂ≠ò‰∏ªÈ¢òID
                localStorage.setItem('between_flow_db_v3', JSON.stringify(data));
            }, [streams, streamMessages, activeStreamId, themeId]);

            // --- Êñ∞Â¢ûÔºöÁõëÂê¨‰∏ªÈ¢òÂèòÂåñÂπ∂Êõ¥Êñ∞ CSS ÂèòÈáè ---
            useEffect(() => {
                const t = THEMES[themeId]?.colors || THEMES.default.colors;
                const root = document.documentElement;
                root.style.setProperty('--bg-sidebar', t.sidebar);
                root.style.setProperty('--scrollbar-thumb', themeId === 'paper'? 'rgba(0,0,0,0.2)': themeId === 'mint'? 'rgba(46,125,50,0.4)': themeId === 'matrix'? '#00ff41': 'rgba(0,0,0,0.6)');
                root.style.setProperty('--bg-main', t.main);
                root.style.setProperty('--bg-input', t.input);
                root.style.setProperty('--text-main', t.text);
                root.style.setProperty('--text-header', t.header);
                root.style.setProperty('--accent-color', t.accent);
                root.style.setProperty('--border-color', themeId === 'paper' || themeId === 'mint' ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)');
            }, [themeId]);

            // --- Êñ∞Â¢ûÔºöÊ∏ÖÁêÜÁºìÂ≠òÈÄªËæë ---
            const handleClearAll = () => {
                try {
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload();
                } catch (e) { console.error("Clear failed", e); }
            };

            useEffect(() => {
                const handleClick = () => { if(globalSelection.show) setGlobalSelection({ show: false, x:0, y:0 }); };
                window.addEventListener('click', handleClick);
                return () => window.removeEventListener('click', handleClick);
            }, [globalSelection.show]);
			
			useEffect(() => {
				const handlePointerDown = (e) => {
					const t = e.target;
                // Fix: Added check for 'reply-click-target' to prevent selection clear logic from interrupting the jump click
				if (t.closest?.('.message-tools') || t.closest?.('.reply-click-target')) return;
				setSelectedMsgId(null);
			};
				window.addEventListener('pointerdown', handlePointerDown, true);
				window.addEventListener('touchstart', handlePointerDown, true);
				return () => {
					window.removeEventListener('pointerdown', handlePointerDown, true);
					window.removeEventListener('touchstart', handlePointerDown, true);
				  };
			}, []);

            const handleCreateStream = () => {
                const newId = 's' + Date.now();
                setStreams(prev => [{ id: newId, title: 'New Thought', isPinned: false, pinOrder: 0, lastUpdated: Date.now() }, ...prev]);
                setStreamMessages(prev => ({ ...prev, [newId]: [] }));
                setActiveStreamId(newId);
                setSidebarOpen(false); 
            };

            const handleMenuAction = (action, streamId) => {
                if (action === 'delete') {
                    setStreams(prev => prev.filter(s => s.id !== streamId));
                    if (activeStreamId === streamId) setActiveStreamId(streams[0]?.id);
                } else if (action === 'togglePin') {
                    setStreams(prev => {
                        const maxOrder = Math.max(...prev.map(s => s.pinOrder || 0), 0);
                        return prev.map(s => s.id === streamId ? { ...s, isPinned: !s.isPinned, pinOrder: !s.isPinned ? maxOrder + 1 : 0 } : s);
                    });
                } else if (action === 'rename') {
                    const newTitle = prompt("Rename stream:", streams.find(s => s.id === streamId)?.title);
                    if (newTitle) setStreams(prev => prev.map(s => s.id === streamId ? { ...s, title: newTitle } : s));
                } else if (action === 'export') {
                    const stream = streams.find(s => s.id === streamId);
                    const msgs = streamMessages[streamId] || [];
                    const markdown = exportStreamToMarkdown(stream, msgs);
                    const blob = new Blob([markdown], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${stream.title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.md`;
                    a.click();
                    URL.revokeObjectURL(url);
                }
            };

            const handleImport = (file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const { title, messages } = parseMarkdownToStream(text);
                    const newId = 's' + Date.now();
                    const newStream = { id: newId, title, isPinned: false, pinOrder: 0, lastUpdated: Date.now() };
                    
                    setStreams(prev => [newStream, ...prev]);
                    setStreamMessages(prev => ({ ...prev, [newId]: messages }));
                    setActiveStreamId(newId);
                    setSidebarOpen(false); 
                };
                reader.readAsText(file);
            };

            const handleMovePinned = useCallback((dragId, hoverId) => { /* simplified */ }, []);

            const handleReorder = useCallback((direction) => {
                if (!selectedMsgId) return;
                setStreamMessages(prev => {
                    const currentMsgs = [...(prev[activeStreamId] || [])];
                    const idx = currentMsgs.findIndex(m => m.id === selectedMsgId);
                    if (idx === -1) return prev;
                    const targetIdx = idx + direction;
                    if (targetIdx < 0 || targetIdx >= currentMsgs.length) return prev; 

                    const temp = currentMsgs[idx];
                    currentMsgs[idx] = currentMsgs[targetIdx];
                    currentMsgs[targetIdx] = temp;

                    const msgA_Index = idx + 1;
                    const msgB_Index = targetIdx + 1;

                    const newMsgsWithRefUpdate = currentMsgs.map(m => {
                        let newContent = m.content;
                        newContent = newContent.replace(new RegExp(`>>#${msgA_Index}(?!\\d)`, 'g'), '>>#_TEMP_'); 
                        newContent = newContent.replace(new RegExp(`>>#${msgB_Index}(?!\\d)`, 'g'), `>>#${msgA_Index}`);
                        newContent = newContent.replace(new RegExp(`>>#_TEMP_`, 'g'), `>>#${msgB_Index}`);
                        return { ...m, content: newContent };
                    });

                    return { ...prev, [activeStreamId]: newMsgsWithRefUpdate };
                });
            }, [selectedMsgId, activeStreamId]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    const isInputFocused = document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT';
                    if (isInputFocused) return;
                    if (e.altKey && e.key === 'ArrowUp') { e.preventDefault(); handleReorder(-1); } 
                    else if (e.altKey && e.key === 'ArrowDown') { e.preventDefault(); handleReorder(1); }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [handleReorder]);
			

			const handleSend = (text, roleColor) => {
			  const newId = Date.now();

			  const newMessage = {
				id: newId,
				index: messages.length + 1,
				username: roleColor.name === 'Default' ? 'Self' : roleColor.name,
				color: roleColor.color,
				timestamp: new Date().toISOString(),
				content: text,
				isSystem: false,
				reactions: [],
				shouldAnimate: true
			  };

			  setStreamMessages(prev => ({
				...prev,
				[activeStreamId]: [...(prev[activeStreamId] || []), newMessage]
			  }));

			  window.setTimeout(() => {
				setStreamMessages(prev => {
				  const list = prev[activeStreamId] || [];
				  return {
					...prev,
					[activeStreamId]: list.map(m =>
					  m.id === newId ? { ...m, shouldAnimate: false } : m
					)
				  };
				});
			  }, 350);

			  let newTitle = "";
			  let shouldRename = false;
			  if (messages.length === 0 && activeStream.title.includes('Thought')) {
				shouldRename = true;
				newTitle = text.trim().substring(0, 15) + (text.length > 15 ? "..." : "");
			  }
			  setStreams(prev =>
				prev.map(s =>
				  s.id === activeStreamId
					? { ...s, lastUpdated: Date.now(), title: shouldRename ? newTitle : s.title }
					: s
				)
			  );
			};
			
            const handleToggleReaction = (msgId, emoji) => {
                setStreamMessages(prev => {
                    const current = prev[activeStreamId];
                    return { ...prev, [activeStreamId]: current.map(m => m.id === msgId ? { ...m, reactions: m.reactions.includes(emoji) ? m.reactions.filter(r => r !== emoji) : [...m.reactions, emoji] } : m) };
                });
                setRecentEmojis(prev => [emoji, ...prev.filter(e => e !== emoji)].slice(0, 4));
                setFullPickerState({ isOpen: false, targetMsgId: null });
            };

            const handleAction = (action, msgId, index, content) => {
                if (action === 'reply') { setReplyTo(index); } 
                else if (action === 'edit') { setEditingId(msgId); } 
                else if (action === 'copy') { if (navigator.clipboard) navigator.clipboard.writeText(content); } 
                else if (action === 'delete') { setStreamMessages(prev => ({ ...prev, [activeStreamId]: prev[activeStreamId].filter(m => m.id !== msgId) })); }
            };

            const handleEditSave = (msgId, newContent) => {
                setStreamMessages(prev => ({ ...prev, [activeStreamId]: prev[activeStreamId].map(m => m.id === msgId ? { ...m, content: newContent } : m) }));
                setEditingId(null);
            };

            const handleJumpTo = (index) => {
                const targetMsg = messages.find(m => m.index === index);
                if (targetMsg) {
                    setHighlightedId(targetMsg.id);
                    document.getElementById(`msg-${index}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => setHighlightedId(null), 1500);
                }
            };

            return (
                <div className="flex flex-col md:flex-row h-[100dvh] w-full bg-[var(--bg-main)] text-[var(--text-main)] font-sans transition-colors duration-300">
                    
                    <Sidebar 
                        streams={streams} 
                        activeStreamId={activeStreamId} 
                        onSelect={setActiveStreamId} 
                        onCreate={handleCreateStream} 
                        onImport={handleImport} 
                        onMenuAction={handleMenuAction} 
                        onMovePinned={() => {}} 
                        isOpen={sidebarOpen}
                        onClose={() => setSidebarOpen(false)}
                        // ‰º†ÈÄí‰∏ªÈ¢òÁõ∏ÂÖ≥ÁöÑ props
                        activeThemeId={themeId}
                        onThemeSelect={setThemeId}
                        onClearAll={handleClearAll}
                    />
                    
                    <div className="flex-1 flex flex-col min-w-0 relative">
                        <ChatHeader 
                            title={activeStream?.title} 
                            isPinned={activeStream?.isPinned} 
                            onMenuClick={() => setSidebarOpen(true)}
                        />
                        <ChatStream 
                            messages={messages} 
                            title={activeStream?.title} 
                            quickReactions={recentEmojis} 
                            onToggleReaction={handleToggleReaction} 
                            onOpenFullPicker={(id) => setFullPickerState({ isOpen: true, targetMsgId: id })}
                            onAction={handleAction}
                            highlightedId={highlightedId}
                            onJumpTo={handleJumpTo}
                            editingId={editingId}
                            onEditSave={handleEditSave}
                            onEditCancel={() => setEditingId(null)}
                            selectedMsgId={selectedMsgId}
                            onSelectMsg={(id) => setSelectedMsgId(prev => (prev === id ? null : id))}
                            onGlobalSelection={setGlobalSelection}
                        />
                        <ThinkingInput 
                            onSend={handleSend} 
                            nextIndex={messages.length + 1} 
                            replyTo={replyTo}
                            onClearReply={() => setReplyTo(null)}
                            inputRef={inputRef}
                            onGlobalSelection={setGlobalSelection}
                        />
                        <EmojiPickerModal isOpen={fullPickerState.isOpen} onClose={() => setFullPickerState({ isOpen: false, targetMsgId: null })} onSelect={(emoji) => handleToggleReaction(fullPickerState.targetMsgId, emoji)} />
                        
                        {/* Global Selection Toolbar (via Portal Concept) */}
                        <SelectionToolbar 
                            visible={globalSelection.show} 
                            position={globalSelection} 
                            mode={globalSelection.isMobile ? 'mobile' : 'pc'} 
                            onFormat={globalSelection.onFormat} 
                        />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
